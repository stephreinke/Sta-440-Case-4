```{r}
library(tidyverse)
library(minpack.lm)

fits_by_genotype <- rootData %>%
  mutate(
    side_binary = ifelse(tolower(side) == "outer", 1, 0),
    midline_scaled = scale(Midline, center = TRUE, scale = TRUE)
  ) %>%
  group_by(Genotype) %>%
  group_map(~ {
    nlsLM(
      Length ~ Asym / (1 + exp((xmid - midline_scaled / (scal + diff * side_binary)))),
      data = .x,
      start = list(
        Asym = max(.x$Length, na.rm = TRUE),
        xmid = 0,
        scal = 1,
        diff = 0.1
      ),
      lower = c(Asym=0, xmid=-Inf, scal=1e-6, diff=-Inf)
    )
  })

rootData <- rootData %>%
  group_by(Genotype) %>%
  mutate(predicted = predict(fits_by_genotype[[cur_group_id()]]))

rootData |>
  filter(Genotype == "WT") |>
ggplot(aes(x = Midline, y = Length, color = side)) +
  geom_point(alpha = 0.6) +
  geom_line(aes(y = predicted), linewidth = 1.2) +
  facet_wrap(~ root) +
  theme_bw() +
  labs(title = "Logistic fits by genotype and side WT")

rootData |>
  filter(Genotype == "MU") |>
ggplot(aes(x = Midline, y = Length, color = side)) +
  geom_point(alpha = 0.6) +
  geom_line(aes(y = predicted), linewidth = 1.2) +
  facet_wrap(~ root) +
  theme_bw() +
  labs(title = "Logistic fits by genotype and side MU")


```

```{r}
summary(fits_by_genotype[[1]])
```

```{r}
summary(fits_by_genotype[[2]])
```

```{r}
# Fitted values
fitted_vals <- fitted(fits_by_genotype[[1]])

# Residuals
residuals_vals <- residuals(fits_by_genotype[[1]])
plot(fitted_vals, residuals_vals,
     xlab = "Fitted values",
     ylab = "Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)
```
