---
title: "Sta 440 Case 4"
author: "Christina Lee, Steph Reinke"
date: "November 2025"
format: 
  pdf:
    documentclass: article
    geometry: margin=1in
execute: 
  warning: false
  message: false
  echo: false
---

# 1. Background

Root growth in the rice plant is characterized by a distinct rotational motion called circumnutation. Researchers want to better understand this process. Experimental data was collected on the developing roots of two strains of rice plants, one a wild type (WT) variety and the other a mutant (MU) variety that lacks circumnutation. In particular, cell length and position measurements were collected on cells on the inner and outer curves of a sample of roots representing the two genetic strains. The protocol utilized in this study is as follows:

1.  The mid–line on the central slice of a root and its point of maximum curvature are identified

2.  The lengths of the cells on the inner and outer curves of the root slice are measured and recorded for those cells falling in a window around the point of maximum curvature.

This process was repeated on nine WT and eleven MU genotype roots. By understanding the differences in growth based on side and genotype, researchers can gain a better understanding of circumnutation and rice plants.

## Research Questions

Can the physical mechanism behind root circumnutation in the wild type plants be explained by differential patterns of cell growth on opposing sides of the root? Is there evidence that these patterns are diminished in the mutant genotype?

# 2. Data and Frequentist Model

To answer these questions we examined the resulting dataset of the process described above. The dataset contains: length, midline (distance from root tip along midline), root ID ((WT)1-9 \$ (MU)1-11), side (inner or outer), and genotype (wild type (WT) & mutant (MU)) for each observation. We conducted exploratory data analysis to see how length varied by root, side, and genotype. For WT roots, there is a visible difference between inner and outer cell lengths, and this difference varies by root id (Fig 1). For MU roots, the inner and outer cell lengths tend to be similar (Fig 2). A combined analysis showed that inner and outer cell lengths are distributed the same for MU roots, while outer tends to be longer than inner cells for WT roots (Fig 3).

We began with a frequentist nonlinear model to explore if Length varied by side and genotype. Our initial approach used was a seven parameter logistic curve with side and genotype effects. However, after discussion we determined that this model inappropriately assumed a constant midline across roots, which limited its biological realism. To address this issue, we refit the data using a four parameter logistic growth model with root specific random effects. The model estimates cell length (Length) as a function of scaled midline position (M): 
$$
\log(\text{Length}) = L + \frac{U - L}{1 + \exp\left(-\frac{\text{M}_{\text{scaled}} - {\text{xmid}}}{s}\right)}
$$

Where: L: lower asymptote (minimum log Length), U: upper asymptote (maximum log Length), xmid: midpoint (inflection point) of sigmoid curve, s: scale parameter

We included fixed effects for side (inner vs outer) and genotype (WT vs MU), as well as their interaction on U and xmid to test whether growth patterns differ across genotypes and sides of the root. Random effects for xmid and s were included at the root level to allow for root specific inflection points and slopes, accounting for biological variability in growth. Because residual plots from earlier indicated heteroskedasticity we log transformed our response variable (Length) to improve model fit.

The model was fit using the nlme package in R. Convergence was achieved by extending the max iterations to 200. Residuals versus fitted values by genotype, side, and root do not show any systematic structure (Fig 4-7). The QQ plot of the residuals followed the diagonal line suggesting that normality was met (Fig 8). The predicted curves by side (outer vs inner) were plotted against the data, which showed goodness of fit. No visible difference could be seen between the two MU curves, but the outer curve had consistently larger lengths for the WT (Fig 9). The key parameters are the side and genotype interaction terms for U and xmid. The estimated coefficient for the interaction between side, genotype and U was negative, but not statistically significant (p-value of 0.5603) (TABLE 1). The estimated coefficient for the interaction between side, genotype, and xmid was negative and statistically significant (p-value of \<0.001) (Table 1). This suggests that for WT roots the inflection point occurs closer to the root base on the outer side compared to the inner side and compared to MU roots. Thus supporting differential patterns of cell growth by side and genotype.f

```{r}
#| label: read_data_and_EDA

library(tidyverse)
library(knitr)
load("rootData.RData")
plot_1 <- rootData |>
  filter(Genotype == "WT") |>
  ggplot(aes(x = Midline, y = Length, color = side)) +
    geom_point(alpha = 0.005) + 
    geom_smooth(method = "loess", se = FALSE) +
    facet_wrap(~ root, scales = "free_x") +
    theme_bw() +
    labs(title = "Cell Length Along the Root Midline for Wild Type",
         x = "Distance along root (µm)",
         y = "Cell length (µm)",
         color = "Side of Root") +
  scale_color_manual(values = c("Inner" = "coral", "Outer" = "darkseagreen"))


plot_2 <- rootData |>
  filter(Genotype == "MU") |>
  ggplot(aes(x = Midline, y = Length, color = side)) +
    geom_point(alpha = 0.005) + 
    geom_smooth(method = "loess", se = FALSE) +
    facet_wrap(~ root, scales = "free_x") +
    theme_bw() +
    labs(title = "Cell Length Along the Root Midline for Mutant Type",
         x = "Distance along root (µm)",
         y = "Cell length (µm)",
         color = "Side of Root") +
  scale_color_manual(values = c("Inner" = "coral", "Outer" = "darkseagreen"))

plot_3 <- ggplot(rootData, aes(x = side, y = Length, fill = side)) +
  geom_boxplot() +
  facet_wrap(~ Genotype) +
  theme_bw() +
  labs(title = "Distribution of Cell Lengths by Genotype and Side",
       x = "Root Side",
       y = "Cell Length (µm)",
       fill = "Side") +
  scale_fill_manual(values = c("Inner" = "coral", "Outer" = "darkseagreen"))


# GOOD MODEL
library(nlme)
library(ggplot2)
library(dplyr)
# Scale the predictor and ensure factors
rootData <- rootData %>%
  mutate(root = factor(root),
         side = factor(side),
         Genotype = factor(Genotype)) %>%
  group_by(root) %>%
  mutate(Midline_scaled = (Midline - min(Midline)) / (max(Midline) - min(Midline))) %>%
  ungroup()

nlme_model <- nlme(
  log(Length) ~ L + (U - L) / (1 + exp(-(Midline_scaled - xmid) / s)),
  data = rootData,
  fixed = list(L ~ 1, 
               U ~ side * Genotype, 
               xmid ~ side * Genotype, 
               s ~ 1),
  random = xmid + s ~ 1 | root,
  start = c(2,           # L intercept
            2.5, 0, 0, 0,  # U: Intercept, side, Genotype, side:Genotype
            0.5, 0, 0, 0,  # xmid: Intercept, side, Genotype, side:Genotype
            0.1),          # s intercept
  control = nlmeControl(maxIter = 200, msMaxIter = 200)
)

# Plot fitted vs observed (back-transform predictions for plotting)
rootData$predicted <- exp(predict(nlme_model))

# Separate plots for WT and MU for better visibility
wt_data <- filter(rootData, Genotype == "WT") %>% 
  mutate(root = droplevels(root))

p_wt <- ggplot(wt_data, aes(x = Midline_scaled, y = Length, color = side)) +
  geom_point(alpha = 0.4, size = 2) + 
  geom_line(aes(y = predicted), linewidth = 1.2) +
  facet_wrap(~ root, ncol = 3) +
  scale_color_manual(values = c("Inner" = "#E41A1C", "Outer" = "#377EB8")) +
  theme_bw(base_size = 12) +
  labs(title = "Wild Type (WT) Roots", x = "Scaled Midline Position", y = "Cell Length")

mu_data <- filter(rootData, Genotype == "MU") %>% 
  mutate(root = droplevels(root))

p_mu <- ggplot(mu_data, aes(x = Midline_scaled, y = Length, color = side)) +
  geom_point(alpha = 0.4, size = 2) +
  geom_line(aes(y = predicted), linewidth = 1.2) +
  facet_wrap(~ root, ncol = 3) +
  scale_color_manual(values = c("Inner" = "#E41A1C", "Outer" = "#377EB8")) +
  theme_bw(base_size = 12) +
  labs(title = "Mutant (MU) Roots", x = "Scaled Midline Position", y = "Cell Length")

# Residual plots
par(mfrow = c(3, 2))

# By root
p2 <- plot(nlme_model, resid(., type = "p") ~ fitted(.) | root, 
     main = "Residuals by Root", layout = c(5, 4))

# By genotype
p3 <- plot(nlme_model, resid(., type = "p") ~ fitted(.) | Genotype,
     main = "Residuals by Genotype")

# By side
p4 <- plot(nlme_model, resid(., type = "p") ~ fitted(.) | side,
     main = "Residuals by Side")

# Overall
p5 <- plot(nlme_model, resid(., type = "p") ~ fitted(.),
     main = "Residuals vs Fitted")

# Q-Q plot
p6 <- qqnorm(nlme_model, ~ resid(., type = "p"), main = "Normal Q-Q Plot")

par(mfrow = c(1, 1))

```

# 3. Bayesian Model

\section*{Main model equation}

\begin{align*}
\log(\text{Length}_{ij}) &\sim \mathcal{N}(\mu_{ij}, \tau_{\text{within}})\\[1em]
\mu_{ij} &= L + \frac{U_{ij} - L}{1 + \exp\left(-\frac{M_{ij} - \text{xmid}_{ij}}{s_{ij}}\right)}
\end{align*}

\section*{Fixed Effects (same as frequentist)}

\textbf{Upper asymptote $(U)$:} \begin{equation*}
U_{ij} = \beta_{U,0} + \beta_{U,\text{side}} \cdot \text{Side}_{ij} + \beta_{U,\text{geno}} \cdot \text{Genotype}_{ij} + \beta_{U,\text{side}\times\text{geno}} \cdot \text{Side}_{ij} \times \text{Genotype}_{ij}
\end{equation*}

\textbf{Midpoint (xmid):} \begin{multline*}
\text{xmid}_{ij} = \beta_{\text{xmid},0} + \beta_{\text{xmid},\text{side}} \cdot \text{Side}_{ij} + \beta_{\text{xmid},\text{geno}} \cdot \text{Genotype}_{ij} \\
+ \beta_{\text{xmid},\text{side}\times\text{geno}} \cdot \text{Side}_{ij} \times \text{Genotype}_{ij} + b_{\text{xmid},j}
\end{multline*}

\textbf{Scale parameter (on log scale for positivity):} \begin{equation*}
s_{ij} = \exp(b_{s,0} + b_{s,j})
\end{equation*}

\section*{Random Effects Priors}

\begin{align*}
b_{\text{xmid},j} &\sim \mathcal{N}(0, \tau_{\text{xmid}})\\[0.5em]
b_{s,j} &\sim \mathcal{N}(0, \tau_s)
\end{align*}

\section*{Fixed Effects Priors}

\begin{align*}
L &\sim \text{Uniform}(1, 3)\\[0.5em]
\beta_{U,0} &\sim \text{Uniform}(2, 4)\\[0.5em]
\beta_{U,\text{side}}, \beta_{U,\text{geno}}, \beta_{U,\text{side}\times\text{geno}} &\sim \mathcal{N}(0, 10)\\[0.5em]
\beta_{\text{xmid},0} &\sim \text{Uniform}(0.3, 0.7)\\[0.5em]
\beta_{\text{xmid},\text{side}}, \beta_{\text{xmid},\text{geno}}, \beta_{\text{xmid},\text{side}\times\text{geno}} &\sim \mathcal{N}(0, 10)\\[0.5em]
b_{s,0} &\sim \mathcal{N}(\log(0.2), 1)
\end{align*}

\section*{Variance Parameter Priors}

\begin{align*}
\sigma &\sim \text{Uniform}(0, 2)\\[0.5em]
\sigma_{\text{xmid}} &\sim \text{Uniform}(0, 1)\\[0.5em]
\sigma_s &\sim \text{Uniform}(0, 1)
\end{align*}

Next, we fit a Bayesian version of our frequentist model using JAGS and MCMC sampling. Because our nonlinear growth model was complex, the dataset was relatively small (20 roots), and the data had a hierarchical structure, a Bayesian approach was beneficial to use. It allowed us to use prior knowledge about biologically reasonable parameter ranges and to obtain stable estimates through partial pooling across roots. We used the four-parameter logistic growth model to describe how cell length (after applying a log transformation) changes along the middle of the root. The model parameters represent key features of growth including the lower asymptote (L) which reflects baseline cell size near the root tip, the upper asymptote (U) which represents maximum cell length in the differentiation zone, the midpoint (xmid) which indicates where elongation is most rapid, and the scale parameter (s) which controls how steeply the transition between zones occurs. To test our main hypothesis that uneven growth between the inner and outer sides of the root causes circumnutation and that it is not present in the mutant, we included fixed effects for side, genotype, and their interaction on both the U and xmid parameters. The interaction terms directly test whether the inner-outer growth difference changes between wild-type and mutant plants. We included random effects for xmid and s (modeled on the log scale to maintain positivity) to account for variation among individual roots and within-root correlation. We also made sure to specify weakly informative priors in order to best reflect reasonable expectations in terms of biology and plants. For example, L had a Uniform(1, 3) prior, U had a Uniform(2, 4) prior to make sure mature cells are larger than the young growing cells, xmid had a Uniform(0.3, 0.7) prior to keep the midpoint within the main root region, and the log-scale parameter for s had a Normal(log(0.2), 1) prior. All side and genotype effects were given Normal(0, 10) priors, which limited extreme values but allowed effects in either direction (positive or negative). Standard deviation parameters had Uniform(0, 2) priors for observation level error and Uniform(0, 1) priors for random effect variability. In total, we ran four MCMC chains for 50,000 iterations, discarded the first 10,000 as burn-in, and retained every 10th sample, which resulted in 16,000 posterior samples.

The Bayesian hierarchical model showed good convergence and fit to the data. For example, the MCMC trace plots showed good mixing across all four chains, and the Gelman-Rubin statistics were near 1.0 for all parameters (Fig 12). Effective sample sizes for all key parameters exceeded 1,300, and most of the random effects achieved ESS values between 3,000 and 8,000 (Fig 13). This shows that there was sufficient posterior sampling. Furthermore, the fitted curves of the Wild Type Roots (Fig 14) show that the model accurately captured the sigmoidal growth pattern in all nine wild-type roots. They also show a clear separation between inner (red) and outer (blue) curves, which adds to supporting the differential growth based on our research question. The residual tests (Fig 15) show that the model assumptions were met. This includes how the residuals were approximately normally distributed according to the Normal Q-Q plot, no systematic patterns being present across the fitted values or scaled midline position, and consistent variance being present across the genotypes and sides (Fig 16). Additionally, the posterior density plots (Fig 17) provided strong evidence supporting the gravitropism hypothesis. The density for the side_effect_WT_U parameter was positive and clearly separated from zero, which indicates that the wild-type roots showed a big enough differential growth, where the outer cells reached greater maximum lengths than inner cells. In contrast, the density for side_effect_MU_U was centered near zero with greater overlap, which shows that there was minimal differential growth in the mutant roots. The density for interaction_xmid showed a negative peak, which indicates that the midpoint of elongation occurred earlier on the outer side in wild-type roots compared to mutants, which is consistent with the asymmetric developmental timing mentioned in the background. The trace plots (Fig 10 & 11) for these parameters indicated stable chains with no signs of non-convergence or autocorrelation, which supports the posterior estimates. Overall, these results provide strong Bayesian evidence that differential cell elongation between the inner and outer sides of the root is emphasized in wild-type plants and reduced in the mutant genotype. This supports the conclusion that differential growth driven by gravitropism is a key feature underlying root circumnutation in rice plants.

# 4. Shortcomings and Assumptions

There were several important limitations and assumptions regarding our insights. The first is that the sample size was relatively small with only 20 root types. This limits statistical power and increases uncertainty around parameter estimates. This is particularly an issue with MU roots, where between root variability was higher. Another limitation is that the frequentist model we chose may have oversimplified the data. A four parameter logistic curve may oversimplify the true biological process of root growth because it assumes smooth, systematic growth along the midline. We assumed that U and L did not vary significantly across roots, which may not reflect reality. Lastly the priors that we chose for our Bayesian model were not chosen through a formal sensitivity analysis. Even though we chose weakly informative priors, they could still have constrained parameters beyond bounds seen in reality.

Both modeling frameworks assume that the residuals are approximately normal with constant variance. Normality was met in both models, with QQ plots that followed the diagonal line (FIG). Residuals for our frequentist model were randomly scattered when examined all together and by side, root, and genotype (FIG). There were slight variances in range for differing roots, but all individual roots roughly followed a random scatter with roughly constant variance. Overall the residuals tended to be more concentrated at lower fitted values. This effect was more prominent in the MU roots than the WT roots.

# 5. Conclusion

Across both frequentist and Bayesian frameworks, we found consistent evidence that wild-type (WT) roots exhibit significant asymmetry in cell elongation, while mutant (MU) roots do not. The frequentist nonlinear mixed-effects model revealed that the inflection point (xmid) occurred significantly closer to the root base on the outer side for WT roots, suggesting earlier elongation onset relative to the inner side. In contrast, MU roots showed no such difference. The Bayesian hierarchical model corroborated these findings, providing strong posterior support that outer-side cells in WT roots achieved larger maximum lengths (U) and earlier elongation midpoints (xmid) than inner-side cells, consistent with asymmetric growth driving circumnutation.

Together, these findings suggest that differential elongation across root sides is a defining feature of wild-type root development and likely represents the physical mechanism underlying circumnutation. The absence of such asymmetry in mutant roots reinforces the hypothesis that the genetic mutation disrupts the gravitropic signaling or growth response necessary for this motion.

# 6. Appendix

```{r}
#| fig-cap: The difference between inner and outer cell lengths changes root by root
plot_1
```

```{r}
#| fig-cap: There is only slight differences between inner and outer cell lengths
plot_2
```

```{r}
#| fig-cap: MU cells have similar inner vs outer lengths; WT outer has longer lengths than inner
plot_3
```

```{r}
#| fig-cap: Residual plot by root id shows variation by root with better scatters for WT
print(p2)
```

```{r}
#| fig-cap: Residuals by Genotype show random scatter and constant variance, MU more dense at lower values
print(p3)
```

```{r}
#| fig-cap: Residuals by Side show random scatter and constant variance more dense at lower values
print(p4)
```

```{r}
#| fig-cap: Residual plot for all data shows random scatter and constant variance, more dense at lower values
print(p5)
```

```{r}
#| fig-cap: QQ plot shows residuals follow diagnol line, shows normality
print(p6)
```

```{r}
#| fig-cap: Data vs fitted curves shows goodness of fit for WT
print(p_wt)
```

```{r}
#| fig-cap: Data vs fitted curves shows goodness of fit for MU
print(p_mu)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(as.data.frame(summary(nlme_model)$tTable),
             caption = "Model output for frequentist model")
```

```{r}
# ============================================================================
# Bayesian Root Growth Model in JAGS
# ============================================================================

library(R2jags)
library(coda)
library(ggplot2)
library(dplyr)
library(loo)   # optional, used later if available

# ---------------------------------------------------------------------------
# 1. PREPARE DATA (assumes rootData exists)
# ---------------------------------------------------------------------------

rootData <- rootData %>%
  mutate(root = factor(root),
         side = factor(side),
         Genotype = factor(Genotype),
         root_num = as.numeric(root),
         side_num = as.numeric(side) - 1,        # 0 = Inner, 1 = Outer
         genotype_num = as.numeric(Genotype) - 1) %>%  # 0 = MU, 1 = WT
  group_by(root) %>%
  mutate(Midline_scaled = (Midline - min(Midline)) / (max(Midline) - min(Midline))) %>%
  ungroup()

# quick checks
stopifnot("Length" %in% names(rootData), "Midline_scaled" %in% names(rootData))

# ---------------------------------------------------------------------------
# 2. WRITE JAGS MODEL (s per-root modelled on log scale for positivity)
# ---------------------------------------------------------------------------

cat("model {
  # Likelihood
  for (i in 1:N) {
    log_Length[i] ~ dnorm(mu[i], within.prec)
    mu[i] <- L + (U[i] - L) / (1 + exp(-(Midline_scaled[i] - xmid[i]) / s[i]))

    # fixed effects for U and xmid (side & genotype & interaction)
    U[i] <- beta_U_int +
            beta_U_side * side_num[i] +
            beta_U_geno * genotype_num[i] +
            beta_U_int_sg * side_num[i] * genotype_num[i]

    xmid[i] <- beta_xmid_int +
               beta_xmid_side * side_num[i] +
               beta_xmid_geno * genotype_num[i] +
               beta_xmid_int_sg * side_num[i] * genotype_num[i] +
               b_xmid[root_num[i]]

    # s positive per-root via log-scale parameterization
    s[i] <- exp(b_s0 + b_s[root_num[i]])
  }

  # Random effects for xmid and for log(s)
  for (j in 1:n_roots) {
    b_xmid[j] ~ dnorm(0, tau_xmid)
    b_s[j] ~ dnorm(0, tau_s)
  }

  # Priors for L (lower asymptote)
  L ~ dunif(1, 3)

  # Priors for U fixed effects
  beta_U_int    ~ dunif(2, 4)
  beta_U_side   ~ dnorm(0, 0.1)
  beta_U_geno   ~ dnorm(0, 0.1)
  beta_U_int_sg ~ dnorm(0, 0.1)

  # Priors for xmid fixed effects
  beta_xmid_int    ~ dunif(0.3, 0.7)
  beta_xmid_side   ~ dnorm(0, 0.1)
  beta_xmid_geno   ~ dnorm(0, 0.1)
  beta_xmid_int_sg ~ dnorm(0, 0.1)

  # Baseline for log(s)
  b_s0 ~ dnorm(log(0.2), 1)   # prior centered at log(0.2), fairly wide

  # Priors for precisions / sd parameters
  sigma ~ dunif(0, 2)         # observation SD (log-length)
  sigma_xmid ~ dunif(0, 1)   # SD of b_xmid
  sigma_s ~ dunif(0, 1)      # SD of log-s random effects

  within.prec <- pow(sigma, -2)
  tau_xmid <- pow(sigma_xmid, -2)
  tau_s <- pow(sigma_s, -2)

  # Derived quantities for interpretation (side effects)
  side_effect_WT_U   <- beta_U_side + beta_U_int_sg
  side_effect_WT_xmid <- beta_xmid_side + beta_xmid_int_sg

  side_effect_MU_U   <- beta_U_side
  side_effect_MU_xmid <- beta_xmid_side

  interaction_U <- beta_U_int_sg
  interaction_xmid <- beta_xmid_int_sg

  # Expose baseline s (on natural scale)
  s0 <- exp(b_s0)
}
", file = "rootModel.jags")

# ---------------------------------------------------------------------------
# 3. PREPARE DATA LIST FOR JAGS
# ---------------------------------------------------------------------------

jags_data <- list(
  log_Length = log(rootData$Length),
  Midline_scaled = rootData$Midline_scaled,
  side_num = rootData$side_num,
  genotype_num = rootData$genotype_num,
  root_num = rootData$root_num,
  N = nrow(rootData),
  n_roots = length(unique(rootData$root))
)

# ---------------------------------------------------------------------------
# 4. SET INITIAL VALUES (consistent with priors)
# ---------------------------------------------------------------------------

inits_function <- function() {
  # ensure initial values are inside prior support and produce positive s[i]
  list(
    L = runif(1, 1.2, 2.8),                  # inside dunif(1,3)
    beta_U_int = runif(1, 2.5, 3.5),         # inside dunif(2,4)
    beta_U_side = rnorm(1, 0, 0.1),
    beta_U_geno = rnorm(1, 0, 0.1),
    beta_U_int_sg = rnorm(1, 0, 0.1),

    beta_xmid_int = runif(1, 0.35, 0.65),    # inside dunif(0.3,0.7)
    beta_xmid_side = rnorm(1, 0, 0.05),
    beta_xmid_geno = rnorm(1, 0, 0.05),
    beta_xmid_int_sg = rnorm(1, 0, 0.05),

    # b_s0 is on log scale; center near log(0.2)
    b_s0 = rnorm(1, log(0.2), 0.2),

    sigma = runif(1, 0.05, 1.0),
    sigma_xmid = runif(1, 0.01, 0.5),
    sigma_s = runif(1, 0.01, 0.5),

    b_xmid = rnorm(jags_data$n_roots, 0, 0.05),
    b_s = rnorm(jags_data$n_roots, 0, 0.05)
  )
}

# quick check of a sample init
test_inits <- inits_function()
stopifnot(test_inits$L >= 1 && test_inits$L <= 3)
stopifnot(test_inits$beta_U_int >= 2 && test_inits$beta_U_int <= 4)

# ---------------------------------------------------------------------------
# 5. PARAMETERS TO MONITOR
# ---------------------------------------------------------------------------

params <- c(
  "L",
  "beta_U_int", "beta_U_side", "beta_U_geno", "beta_U_int_sg",
  "beta_xmid_int", "beta_xmid_side", "beta_xmid_geno", "beta_xmid_int_sg",
  "b_s0", "s0", "sigma", "sigma_xmid", "sigma_s",
  "side_effect_WT_U", "side_effect_WT_xmid",
  "side_effect_MU_U", "side_effect_MU_xmid",
  "interaction_U", "interaction_xmid",
  "b_xmid", "b_s"
)

# ---------------------------------------------------------------------------
# 6. RUN JAGS
# ---------------------------------------------------------------------------

cat("Running JAGS with 4 chains...\n")
jags_fit <- jags(
  data = jags_data,
  inits = inits_function,
  parameters.to.save = params,
  model.file = "rootModel.jags",
  n.chains = 4,
  n.iter = 50000,
  n.burnin = 10000,
  n.thin = 10,
  DIC = TRUE,
  progress.bar = "text"
)

print(jags_fit)

# ---------------------------------------------------------------------------
# 7. MCMC DIAGNOSTICS & convert to matrix
# ---------------------------------------------------------------------------

sims <- as.mcmc(jags_fit)
sims_matrix <- as.matrix(sims)   # rows = draws, cols = parameter names

# Gelman-Rubin
cat("\n=== GELMAN-RUBIN ===\n")
print(gelman.diag(sims, transform = TRUE, multivariate = FALSE))

# Effective sample size
cat("\n=== EFFECTIVE SAMPLE SIZE (first 30) ===\n")
print(effectiveSize(sims)[1:30])

# ---------------------------------------------------------------------------
# 8. COMPUTE PREDICTIONS
# ---------------------------------------------------------------------------

# Extract posterior means of scalars and random effects
L_post <- mean(sims_matrix[, "L"])
beta_U_int_post <- mean(sims_matrix[, "beta_U_int"])
beta_U_side_post <- mean(sims_matrix[, "beta_U_side"])
beta_U_geno_post <- mean(sims_matrix[, "beta_U_geno"])
beta_U_int_sg_post <- mean(sims_matrix[, "beta_U_int_sg"])

beta_xmid_int_post <- mean(sims_matrix[, "beta_xmid_int"])
beta_xmid_side_post <- mean(sims_matrix[, "beta_xmid_side"])
beta_xmid_geno_post <- mean(sims_matrix[, "beta_xmid_geno"])
beta_xmid_int_sg_post <- mean(sims_matrix[, "beta_xmid_int_sg"])

# random effects (b_xmid[1], ..., b_xmid[n_roots]) and b_s[1..n_roots]
b_xmid_post <- colMeans(sims_matrix[, grep("^b_xmid\\[", colnames(sims_matrix))])
b_s_post <- colMeans(sims_matrix[, grep("^b_s\\[", colnames(sims_matrix))])
b_s0_post <- mean(sims_matrix[, "b_s0"])
s0_post <- mean(sims_matrix[, "s0"])

# Compute predicted quantities per observation
rootData$U_pred <- beta_U_int_post +
  beta_U_side_post * rootData$side_num +
  beta_U_geno_post * rootData$genotype_num +
  beta_U_int_sg_post * rootData$side_num * rootData$genotype_num

rootData$xmid_pred <- beta_xmid_int_post +
  beta_xmid_side_post * rootData$side_num +
  beta_xmid_geno_post * rootData$genotype_num +
  beta_xmid_int_sg_post * rootData$side_num * rootData$genotype_num +
  b_xmid_post[rootData$root_num]

# per-root s (positive)
rootData$s_pred <- exp(b_s0_post + b_s_post[rootData$root_num])

rootData$log_Length_pred <- L_post +
  (rootData$U_pred - L_post) / (1 + exp(-(rootData$Midline_scaled - rootData$xmid_pred) / rootData$s_pred))

rootData$Length_pred <- exp(rootData$log_Length_pred)
rootData$residuals <- log(rootData$Length) - rootData$log_Length_pred

# quick residual summary printed
cat("\n--- Residual summary (log scale) ---\n")
print(summary(rootData$residuals))

# ---------------------------------------------------------------------------
# 9. Posterior summaries & HPD
# ---------------------------------------------------------------------------

cat("\n=== POSTERIOR SUMMARY ===\n")
print(summary(sims))

cat("\n=== 95% HPD INTERVALS (first 40 rows if available) ===\n")
hpd <- HPDinterval(sims)
print(head(hpd[[1]], 40))

# Save results
saveRDS(jags_fit, file = "jags_fit_results.rds")
saveRDS(rootData, file = "rootData_with_preds.rds")
```


```{r fig.width=10, fig.height=8, fig.cap="Trace plots for main parameters"}
#| fig-cap: Trace plots for main parameters
# fig 10
# Trace plots - main parameters
par(mfrow = c(3, 3))
traceplot(sims[, c("L", "s0", "sigma", "sigma_xmid",
                   "side_effect_WT_U", "side_effect_WT_xmid",
                   "side_effect_MU_U", "side_effect_MU_xmid",
                   "interaction_xmid")])
```

```{r fig.width=10, fig.height=8, fig.cap="Trace plots for beta parameters"}
#| fig-cap: Trace plots for beta parameters
# fig 11
# Trace plots - betas
par(mfrow = c(4, 2))
traceplot(sims[, c("beta_U_int", "beta_U_side", "beta_U_geno", "beta_U_int_sg",
                   "beta_xmid_int", "beta_xmid_side", "beta_xmid_geno", "beta_xmid_int_sg")])
```

```{r gelman-diagnostics, echo=FALSE, fig.cap="Gelman-Rubin convergence diagnostics for main parameters"}
# Gelman-Rubin diagnostics
#| fig-cap: Gelman-Rubin convergence diagnostics for main parameters
# fig 12
library(knitr)

gelman_results <- gelman.diag(sims, transform = TRUE, multivariate = FALSE)

kable(gelman_results$psrf, 
      digits = 3)
```

```{r effective-size, echo=FALSE, fig.cap= "Effective sample sizes"}
# Effective sample sizes 
#| fig-cap: Effective sample sizes 
# fig 13
library(knitr)
library(kableExtra)

# Compute effective sample sizes
eff_sizes <- effectiveSize(sims)[1:30]

# Convert to a data frame for kable
eff_df <- data.frame(
  Parameter = names(eff_sizes),
  EffectiveSize = as.numeric(eff_sizes)
)

# Create a nicely formatted table
kable(eff_df,
      digits = 1,
      col.names = c("Parameter", "Effective Sample Size")) |>
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover"))

```

```{r fig.width=12, fig.height=8, fig.cap="Bayesian fitted curves for WT genotype"}
# Fitted vs observed - WT
#| fig-cap: Bayesian fitted curves for WT genotype
# fig 14
p_wt_bayes <- ggplot(filter(rootData, Genotype == "WT"),
                     aes(x = Midline_scaled, y = Length, color = side)) +
  geom_point(alpha = 0.4, size = 2) +
  geom_line(aes(y = Length_pred), linewidth = 1.2) +
  facet_wrap(~ root, ncol = 3) +
  theme_bw() + 
  labs(title = "Bayesian Fit: WT", x = "Scaled Midline", y = "Cell Length")
print(p_wt_bayes)
```

```{r fig.width=10, fig.height=3, fig.cap="Residuals vs Fitted"}
#| fig-cap: Residuals vs Fitted
# fig 15
par(mfrow = c(1, 3))
plot(rootData$log_Length_pred, rootData$residuals,
     main = "Residuals vs Fitted",
     xlab = "Fitted log(Length)", ylab = "Residuals")
abline(h = 0, col = "red", lty = 2)

qqnorm(rootData$residuals, main = "Normal Q-Q Plot")
qqline(rootData$residuals, col = "red")

hist(rootData$residuals, breaks = 30, main = "Histogram of residuals", 
     xlab = "Residuals", col = "lightblue")
```

```{r fig.width=10, fig.height=3, fig.cap="Residuals by grouping variables"}
#| fig-cap: Residuals by grouping variables
# fig 16
par(mfrow = c(1, 3))
boxplot(residuals ~ Genotype, data = rootData, main = "Residuals by Genotype")
abline(h = 0, col = "red")

boxplot(residuals ~ side, data = rootData, main = "Residuals by Side")
abline(h = 0, col = "red")

plot(rootData$Midline_scaled, rootData$residuals, 
     main = "Residuals vs Midline_scaled",
     xlab = "Midline_scaled", ylab = "Residuals")
abline(h = 0, col = "red")
```

```{r fig.width=10, fig.height=8, fig.cap="Posterior density plots"}
#| fig-cap: Posterior density plots
# fig 17
# Posterior densities
par(mfrow = c(3, 3))
densplot(sims[, c("L", "s0", "sigma", "sigma_xmid",
                  "side_effect_WT_U", "side_effect_WT_xmid",
                  "side_effect_MU_U", "side_effect_MU_xmid",
                  "interaction_xmid")])
```
