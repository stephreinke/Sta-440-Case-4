---
title: "Jags"
format: html
---
```{r}
# --- Libraries ---
library(R2jags)
library(coda)

# --- Prepare data ---
rootData$logLength <- log(rootData$Length)

# Make sure the indicator columns are numeric (0/1)
rootData$WT    <- as.numeric(rootData$WT)       # genotype indicator
rootData$outer <- as.numeric(rootData$outer)    # side indicator

# --- safe JAGS model file ---
cat("
model {
  for (i in 1:N) {
    logL[i] ~ dnorm(mu[i], tau)
    # Lmax for observation i (must be positive)
    Lmax_i[i] <- exp(logLmax0 + logLmax_gen * isMU[i] + logLmax_side * isOuter[i] + logLmax_int * isMU[i] * isOuter[i])

    # Lmin positive via exp()
    Lmin_pos <- exp(logLmin)

    # logistic-like inner expression; add tiny eps to avoid log(0) if numerical rounding occurs
    inner[i] <- Lmin_pos + ((Lmax_i[i] - Lmin_pos) / (1 + exp(-(Midline[i] - xmid)/s)))
    mu[i] <- log( inner[i] + 1e-8 )   # tiny epsilon to avoid exact 0
  }

  # Priors on log-scale keep positivity and help sampling stability
  logLmin     ~ dnorm(log(1), 1.0E-2)     # center near log(1); increase precision if you want narrower prior
  logLmax0    ~ dnorm(log(10), 1.0E-2)
  logLmax_gen ~ dnorm(0, 1.0E-2)
  logLmax_side~ dnorm(0, 1.0E-2)
  logLmax_int ~ dnorm(0, 1.0E-2)

  # Midpoint and slope (xmid can be any real; s must be positive)
  xmid ~ dnorm(0, 1.0E-4)
  s    ~ dgamma(2, 1)    # shape=2, rate=1 gives a reasonable positive scale

  # observation variance
  sigma ~ dunif(0, 20)
  tau <- pow(sigma, -2)
}
", file = "rootModel_safe.jags")

# --- JAGS data list ---
data_list <- list(
  N        = nrow(rootData),
  logL     = rootData$logLength,
  Midline  = rootData$Midline_s,
  isMU     = rootData$WT,
  isOuter  = rootData$outer
)

# --- Initial values ---
inits_fn <- function() {
  list(
    Lmin = runif(1, 1, 10),
    Lmax0 = runif(1, 5, 20),
    Lmax_gen = rnorm(1, 0, 1),
    Lmax_side = rnorm(1, 0, 1),
    Lmax_int = rnorm(1, 0, 1),
    xmid = rnorm(1, 0.25, 0.1),
    s = runif(1, 0.01, 1),
    sigma = runif(1, 0.1, 2)
  )
}

params <- c("Lmin","Lmax0","Lmax_gen","Lmax_side","Lmax_int","xmid","s","sigma")

# --- Run JAGS ---
jags_out <- jags(
  data = data_list,
  inits = inits_fn,
  parameters.to.save = params,
  model.file = "rootModel.jags",
  n.chains = 4,
  n.iter = 50000,
  n.burnin = 10000,
  n.thin = 2,
  DIC = FALSE
)

print(jags_out)
mcmc_chains <- as.mcmc(jags_out)

# --- Diagnostics like in your slides ---
gelman.plot(mcmc_chains)
gelman.diag(mcmc_chains)
effectiveSize(mcmc_chains)
raftery.diag(mcmc_chains)
autocorr.plot(mcmc_chains)
summary(mcmc_chains)
HPDinterval(mcmc_chains)

mcmc_chains
```

```{r}

# Convert JAGS output to mcmc.list (already done)
mcmc_chains <- as.mcmc(jags_out)

# --- Trace plots ---
# Trace plots for all monitored parameters
traceplot(mcmc_chains)

# If you want to plot a specific parameter, e.g., 'Lmin':
traceplot(mcmc_chains[, "Lmin"])

# You can also combine with density plots
densplot(mcmc_chains)


```

