---
title: "ChristinaModeling"
format: html
---

```{r}
# packages
library(ggplot2)
library(dplyr)
library(tidyr)
library(MASS)   # for mvrnorm in bootstrap
load("rootData.RData")
```

```{r}
# GOOD MODEL
library(nlme)
library(ggplot2)
library(dplyr)

# Check unique values first
cat("Unique Genotypes:", unique(rootData$Genotype), "\n")
cat("Unique Sides:", unique(rootData$side), "\n")
cat("Unique Roots:", unique(rootData$root), "\n\n")

# Scale the predictor and ensure factors
rootData <- rootData %>%
  mutate(root = factor(root),
         side = factor(side),
         Genotype = factor(Genotype)) %>%
  group_by(root) %>%
  mutate(Midline_scaled = (Midline - min(Midline)) / (max(Midline) - min(Midline))) %>%
  ungroup()

# Fit NLME model with Genotype-by-side interaction
# 4-parameter logistic: log(Length) = L + (U - L) / (1 + exp(-(Midline_scaled - xmid) / s))
# Random effects on xmid and s by root
# Fixed effects: side AND Genotype:side interaction on U and xmid

nlme_model <- nlme(
  log(Length) ~ L + (U - L) / (1 + exp(-(Midline_scaled - xmid) / s)),
  data = rootData,
  fixed = list(L ~ 1, 
               U ~ side * Genotype, 
               xmid ~ side * Genotype, 
               s ~ 1),
  random = xmid + s ~ 1 | root,
  start = c(2,           # L intercept
            2.5, 0, 0, 0,  # U: Intercept, side, Genotype, side:Genotype
            0.5, 0, 0, 0,  # xmid: Intercept, side, Genotype, side:Genotype
            0.1),          # s intercept
  control = nlmeControl(maxIter = 200, msMaxIter = 200)
)

# Model summary
cat("Model equation:\n")
cat("log(Length) = L + (U - L) / (1 + exp(-(Midline_scaled - xmid) / s))\n\n")
cat("Random effects: xmid and s vary by root (allows curves to shift/stretch)\n")
cat("Fixed effects: U and xmid vary by side AND Genotype (tests if differential growth differs by genotype)\n\n")

summary(nlme_model)

cat("\n=== KEY FOR RESEARCH QUESTION ===\n")
cat("Look at the side:Genotype interaction terms:\n")
cat("- If side:GenotypeMU is negative/significant for U or xmid:\n")
cat("  â†’ Differential growth (Inner vs Outer) is DIMINISHED in mutant\n")
cat("- This supports the gravitropism hypothesis\n\n")

# Plot fitted vs observed (back-transform predictions for plotting)
rootData$predicted <- exp(predict(nlme_model))

# Separate plots for WT and MU for better visibility
wt_data <- filter(rootData, Genotype == "WT") %>% 
  mutate(root = droplevels(root))

p_wt <- ggplot(wt_data, aes(x = Midline_scaled, y = Length, color = side)) +
  geom_point(alpha = 0.4, size = 2) +
  geom_line(aes(y = predicted), linewidth = 1.2) +
  facet_wrap(~ root, ncol = 3) +
  scale_color_manual(values = c("Inner" = "#E41A1C", "Outer" = "#377EB8")) +
  theme_bw(base_size = 12) +
  labs(title = "Wild Type (WT) Roots", x = "Scaled Midline Position", y = "Cell Length")

mu_data <- filter(rootData, Genotype == "MU") %>% 
  mutate(root = droplevels(root))

p_mu <- ggplot(mu_data, aes(x = Midline_scaled, y = Length, color = side)) +
  geom_point(alpha = 0.4, size = 2) +
  geom_line(aes(y = predicted), linewidth = 1.2) +
  facet_wrap(~ root, ncol = 3) +
  scale_color_manual(values = c("Inner" = "#E41A1C", "Outer" = "#377EB8")) +
  theme_bw(base_size = 12) +
  labs(title = "Mutant (MU) Roots", x = "Scaled Midline Position", y = "Cell Length")

print(p_wt)
print(p_mu)

# Residual plots
par(mfrow = c(3, 2))

# By root
plot(nlme_model, resid(., type = "p") ~ fitted(.) | root, 
     main = "Residuals by Root", layout = c(6, 3))

# By genotype
plot(nlme_model, resid(., type = "p") ~ fitted(.) | Genotype,
     main = "Residuals by Genotype")

# By side
plot(nlme_model, resid(., type = "p") ~ fitted(.) | side,
     main = "Residuals by Side")

# Overall
plot(nlme_model, resid(., type = "p") ~ fitted(.),
     main = "Residuals vs Fitted")

# Q-Q plot
qqnorm(nlme_model, ~ resid(., type = "p"), main = "Normal Q-Q Plot")

# By Midline
plot(nlme_model, resid(., type = "p") ~ Midline_scaled,
     main = "Residuals vs Scaled Midline")

par(mfrow = c(1, 1))
```